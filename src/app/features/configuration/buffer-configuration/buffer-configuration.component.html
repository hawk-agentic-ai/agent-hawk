<div class="p-6">
  <!-- Page Header -->
  <div class="mb-6">
    <div class="flex justify-between items-center">
      <div>
        <h2 class="text-xl font-semibold text-gray-900 mb-2">Buffer Configuration</h2>
        <p class="text-gray-600">Manage buffer rules and allocations</p>
      </div>
      <button class="btn btn-primary" (click)="openAdd()">
        <i class="pi pi-plus"></i>
        <span>Add Buffer Rule</span>
      </button>
    </div>
  </div>

  <!-- Search Bar -->
  <div class="flex items-center gap-4 mb-4">
    <div class="flex-1 flex items-center gap-2">
      <label class="filter-label">Search:</label>
      <input type="text" placeholder="Search rule id, entity, currency..." [(ngModel)]="search" (ngModelChange)="onSearchChange($event)" class="filter-input flex-1 max-w-xs">
    </div>
  </div>

  <!-- Data Grid -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <ag-grid-angular
      class="ag-theme-alpine w-full"
      style="height: 600px;"
      [columnDefs]="columnDefs"
      [rowData]="rows"
      [defaultColDef]="defaultColDef"
      [gridOptions]="gridOptions"
      (gridReady)="onGridReady($event)">
    </ag-grid-angular>
  </div>

  <!-- Add/Edit Dialog -->
  <p-dialog 
    header="{{ mode === 'edit' ? 'Edit Buffer Rule' : 'Add Buffer Rule' }}" 
    [(visible)]="showDialog"
    [modal]="true"
    [style]="{width: '100vw', height: '95vh', 'max-width': '100vw', 'max-height': '95vh', 'border-top-left-radius': '16px', 'border-top-right-radius': '16px'}"
    [closable]="true"
    styleClass="entity-dialog entity-dialog-full">

    <form class="space-y-6 p-2">
      <!-- Section: Basic Info -->
      <div class="rounded-lg border border-gray-200 p-4 bg-white">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-3 flex items-center">
            <div class="text-sm font-semibold text-gray-700">Basic Info</div>
          </div>
          <div class="col-span-12 md:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Rule ID</label>
                <input type="text" class="filter-input w-full" [(ngModel)]="form.buffer_rule_id" name="buffer_rule_id" [readonly]="mode==='edit'" placeholder="Unique rule id"/>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Entity Type</label>
                <p-dropdown [options]="entityTypeOptions"
                            [(ngModel)]="form.entity_type"
                            name="entity_type"
                            placeholder="Select entity type"
                            (onChange)="onEntityTypeChange($event.value)"
                            styleClass="filter-input w-full"
                            [style]="{width:'100%'}"></p-dropdown>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Entity</label>
                <p-dropdown [options]="entityIdOptions"
                            [(ngModel)]="form.entity_id"
                            name="entity_id"
                            placeholder="Select entity"
                            (onChange)="onEntityChange($event.value)"
                            styleClass="filter-input w-full"
                            [style]="{width:'100%'}"></p-dropdown>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Currency Code</label>
                <input type="text" class="filter-input w-full" [(ngModel)]="form.currency_code" name="currency_code" placeholder="e.g., USD"/>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Hedge State</label>
                <p-dropdown [options]="hedgingFrameworkOptions"
                            [(ngModel)]="form.hedging_framework"
                            name="hedging_framework"
                            placeholder="Select framework"
                            styleClass="filter-input w-full"
                            [style]="{width:'100%'}"></p-dropdown>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Active</label>
                <p-dropdown [options]="[{label: 'Active', value: 'Y'}, {label: 'Inactive', value: 'N'}]"
                            [(ngModel)]="form.active_flag"
                            name="active_flag"
                            placeholder="Select status"
                            styleClass="filter-input w-full"
                            [style]="{width:'100%'}"></p-dropdown>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Amounts & Percentage -->
      <div class="rounded-lg border border-gray-200 p-4 bg-white">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-3 flex items-center">
            <div class="text-sm font-semibold text-gray-700">Amounts & Percentage</div>
          </div>
          <div class="col-span-12 md:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Minimum Buffer Amount</label>
                <input type="number" class="filter-input w-full" [(ngModel)]="form.minimum_buffer_amount" name="minimum_buffer_amount" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Maximum Buffer Amount</label>
                <input type="number" class="filter-input w-full" [(ngModel)]="form.maximum_buffer_amount" name="maximum_buffer_amount" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Buffer Percentage</label>
                <input type="number" class="filter-input w-full" [(ngModel)]="form.buffer_percentage" name="buffer_percentage" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Dates -->
      <div class="rounded-lg border border-gray-200 p-4 bg-white">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-3 flex items-center">
            <div class="text-sm font-semibold text-gray-700">Dates</div>
          </div>
          <div class="col-span-12 md:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Effective Date</label>
                <input type="date" class="filter-input w-full" [(ngModel)]="form.effective_date" name="effective_date" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Expiry Date</label>
                <input type="date" class="filter-input w-full" [(ngModel)]="form.expiry_date" name="expiry_date" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Rules & Flags -->
      <div class="rounded-lg border border-gray-200 p-4 bg-white">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-3 flex items-center">
            <div class="text-sm font-semibold text-gray-700">Rules & Flags</div>
          </div>
          <div class="col-span-12 md:col-span-9">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Rule Priority</label>
                <input type="number" class="filter-input w-full" [(ngModel)]="form.rule_priority" name="rule_priority" />
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">NAV Type Priority</label>
                <input type="text" class="filter-input w-full" [(ngModel)]="form.nav_type_priority" name="nav_type_priority" placeholder="e.g., Trading>Investment"/>
              </div>
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">CAR Exemption</label>
                <select class="filter-input w-full" [(ngModel)]="form.car_exemption_flag" name="car_exemption_flag">
                  <option [ngValue]="undefined">--</option>
                  <option value="Y">Y</option>
                  <option value="N">N</option>
                </select>
              </div>
              <div class="field md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Buffer Allocation Method</label>
                <input type="text" class="filter-input w-full" [(ngModel)]="form.buffer_allocation_method" name="buffer_allocation_method" placeholder="e.g., proportional"/>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Section: Business Rule Description -->
      <div class="rounded-lg border border-gray-200 p-4 bg-white">
        <div class="grid grid-cols-12 gap-4">
          <div class="col-span-12 md:col-span-3 flex items-center">
            <div class="text-sm font-semibold text-gray-700">Business Rule</div>
          </div>
          <div class="col-span-12 md:col-span-9">
            <div class="grid grid-cols-1 gap-4">
              <div class="field">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <input type="text" class="filter-input w-full" [(ngModel)]="form.business_rule_description" name="business_rule_description" placeholder="Short description"/>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <ng-template pTemplate="footer">
      <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
        <button class="btn btn-secondary" (click)="showDialog = false">Cancel</button>
        <button class="btn btn-primary" (click)="confirmSave()">{{ mode === 'edit' ? 'Update' : 'Save' }}</button>
      </div>
    </ng-template>
  </p-dialog>
</div>
