import { Component, EventEmitter, Input, Output, OnChanges, SimpleChanges, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { PromptTemplate } from '../../configuration/prompt-templates/prompt-templates.service';
import { CurrencyService } from '../../../shared/services/currency.service';
import { EntityMasterService, EntityMaster } from '../../configuration/entity/entity-master.service';

@Component({
  selector: 'app-pt-preview',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div class="h-full flex flex-col">
      <div class="border-b pb-2 mb-2">
        <div class="text-sm text-gray-500">Template</div>
        <div class="text-base font-semibold text-gray-900 truncate">{{ template?.name || 'Select a template' }}</div>
      </div>
      <div class="flex-1 min-h-0 overflow-auto space-y-3">
        <ng-container *ngIf="template; else empty">
          <div>
            <div class="text-xs text-gray-500 mb-1">Prompt Text (live)</div>
            <pre class="bg-gray-50 border rounded p-2 text-xs whitespace-pre-wrap">{{ filledPrompt || (template ? template.prompt_text : '') }}</pre>
          </div>
          <div *ngIf="fields?.length; else noParams">
            <div class="text-xs text-gray-500 mb-1">Input Parameters</div>
            <div class="grid grid-cols-1 gap-2">
              <label *ngFor="let f of fields" class="text-xs">
                <span class="block text-[11px] text-gray-600 mb-1">{{ f }}</span>
                <ng-container *ngIf="isSelect(f); else textField">
                  <select class="filter-input w-full" [(ngModel)]="values[f]" (ngModelChange)="computeFilled()">
                    <option value="">-- Select --</option>
                    <ng-container *ngIf="f.toLowerCase().includes('currency'); else entityOpts">
                      <option *ngFor="let c of currencyOptions" [value]="c">{{ c }}</option>
                    </ng-container>
                    <ng-template #entityOpts>
                      <option *ngFor="let e of entityOptions" [value]="e.value">{{ e.label }}</option>
                    </ng-template>
                  </select>
                </ng-container>
                <ng-template #textField>
                  <input class="filter-input w-full" [type]="getType(f)" [(ngModel)]="values[f]" (ngModelChange)="computeFilled()" [placeholder]="getPlaceholder(f)" />
                </ng-template>
              </label>
            </div>
          </div>
          <ng-template #noParams>
            <div class="text-xs text-gray-500">No input parameters detected from the prompt.</div>
          </ng-template>
          <div class="pt-2 mt-2 border-t flex items-center justify-end">
            <button class="btn btn-primary" (click)="send()"><i class="pi pi-send"></i><span>Submit</span></button>
          </div>
          <div *ngIf="responseText" class="mt-3">
            <div class="text-xs text-gray-500 mb-1">Response</div>
            <div class="bg-white border rounded p-3 text-sm whitespace-pre-wrap">{{ responseText }}</div>
          </div>
        </ng-container>
        <ng-template #empty>
          <div class="text-sm text-gray-500">Choose a template to see details.</div>
        </ng-template>
      </div>
    </div>
  `
})
export class TemplatePreviewComponent implements OnChanges, OnInit {
  @Input() template: PromptTemplate | null = null;
  @Input() fields: string[] = [];
  @Output() onSend = new EventEmitter<{ text: string; values: Record<string,string> }>();
  @Input() responseText = '';
  values: Record<string,string> = {};
  filledPrompt = '';
  currencyOptions: string[] = [];
  entityOptions: { label: string; value: string }[] = [];

  send(){
    const text = this.filledPrompt || (this.template?.prompt_text || '');
    this.onSend.emit({ text, values: this.values });
  }
  getType(f: string){
    const name = (f||'').toLowerCase();
    if (name.includes('date')) return 'date';
    if (name.includes('amount') || name.includes('qty') || name.includes('quantity') || name.includes('rate')) return 'number';
    return 'text';
  }
  getPlaceholder(f: string){
    const name = (f||'').toLowerCase();
    if (name.includes('date')) return 'YYYY-MM-DD';
    if (name.includes('currency')) return 'e.g., USD';
    if (name.includes('amount') || name.includes('qty') || name.includes('quantity')) return 'e.g., 100000';
    if (name.includes('rate')) return 'e.g., 0.05';
    if (name.includes('entity')) return 'e.g., Entity A';
    return `Enter ${f}`;
  }
  isSelect(f: string){
    const name = (f||'').toLowerCase();
    return name.includes('currency') || name === 'entity' || name.includes('entity_id') || name.includes('entity_code') || name.includes('entity_name');
  }
  getSelectOptions(f: string){
    const name = (f||'').toLowerCase();
    if (name.includes('currency')) return this.currencyOptions;
    if (name === 'entity' || name.includes('entity_id') || name.includes('entity_code') || name.includes('entity_name')) return this.entityOptions;
    return [] as any;
  }
  ngOnInit(){
    // Load currency options
    try { this.currencySvc.getCurrencyCodes().subscribe(list => this.currencyOptions = list || []); } catch {}
    // Load entity options
    try {
      this.entitySvc.entities$.subscribe((ents: EntityMaster[]) => {
        const items = (ents||[]).map(e => ({ label: `${e.entity_name} (${e.legal_entity_code})`, value: e.legal_entity_code }));
        this.entityOptions = items;
      });
    } catch {}
  }
  ngOnChanges(ch: SimpleChanges){
    if (ch['template'] || ch['fields']){
      this.values = {};
      (this.fields||[]).forEach(f=> this.values[f] = this.values[f] ?? '');
      this.computeFilled();
    }
  }
  computeFilled(){
    const text = this.template?.prompt_text || '';
    let out = text;
    Object.keys(this.values||{}).forEach(k => {
      const v = this.values[k] || `{{${k}}}`;
      const brace = new RegExp(`\\{\\{\\s*${this.escapeReg(k)}\\s*\\}\\}`,'gi');
      const bracket = new RegExp(`\\[\\s*${this.escapeReg(k)}\\s*\\]`,'gi');
      out = out.replace(brace, v).replace(bracket, v);
    });
    this.filledPrompt = out;
  }
  escapeReg(s:string){ return s.replace(/[.*+?^${}()|[\\]\\]/g,'\\$&'); }
  // quick fill removed per request
}
